# Правила работы с проектом Jarvis Manipulator

## Структура проекта

### Папки
- `tests/` - все тестовые скрипты должны находиться здесь
- `logs/` - логи автоматически сохраняются и очищаются через 7 дней
- `screenshots/` - временные скриншоты для Vision API
- `temp/` - временные файлы (голосовые сообщения и т.д.)

### Ключевые файлы
- `system_capabilities.yaml` - конфигурация возможностей системы для AI
- `config.py` - настройки (API ключи, пути и т.д.)
- `main.py` - точка входа для Telegram бота

## Правила разработки

### Тестирование
- **ВСЕ тесты** создавать в папке `tests/`
- Тестовые файлы именовать как `test_*.py`
- Каждый тест должен логировать в `logs/test_*.log`
- Тесты НЕ должны требовать Telegram (использовать заглушки)

### Логирование
- Использовать максимальный уровень логирования для отладки
- Логи сохранять с временной меткой: `logs/{module}_{timestamp}.log`
- Критичные операции логировать с контекстом (параметры, результаты)

### Vision API
- Использовать ТОЛЬКО модели Gemini 2.5+ (2.5-pro, 2.5-flash)
- Всегда логировать промпты и ответы от Vision API
- Применять коррекцию координат для Retina дисплеев

### Планирование
- Следовать двухуровневой системе (high_level + low_level)
- МАКСИМУМ 2-4 шага в одном плане
- Приоритет: TERMINAL > API > VISUAL_CLICK

### Координаты и клики
- Всегда применять `coordinate_correction.py` для Retina дисплеев
- Система поиска координат: **итеративное уточнение с линейками** (ruler-based)
  - Запрос начальных координат у Gemini Vision
  - Вырезка области 1000x1000px (500px в каждую сторону от точки)
  - Увеличение в 3 раза для точности
  - Рисование точки + линейки (желтая горизонтальная, голубая вертикальная)
  - Итеративная коррекция до подтверждения (макс 5 итераций)
  - Если элемент не виден на фрагменте - возврат к полному скриншоту
- Не использовать grid/сетку - старая система НЕ работала
- НЕ упоминать "центр кнопки", только "точка клика активирует кнопку"
- `tests/ruler_based_finder.py` - STANDALONE скрипт для тестирования
- `self_correcting_executor.py` - интегрированная система для production
- **Промпт для Gemini** обновлен: достаточно попадания в область элемента, не нужен перфекционизм

### Параллельная работа с пользователем
- Перед каждым действием (кроме TERMINAL/WAIT):
  - Проверка активности пользователя
  - Ожидание бездействия 2.2 секунды
  - Уведомление если пользователь активен
- Проверка активности нужного приложения перед UI действиями
- `user_activity_detector.py` - детектор активности через macOS API

## Архитектура

### Иерархия приоритетов действий
1. **TERMINAL** - открытие приложений, системные команды
2. **ACCESSIBILITY_API** - (не реализовано) UI элементы через macOS API
3. **MCP_SERVERS** - (не настроено) интеграции с сервисами
4. **VISUAL_CLICK** - последний resort, через Vision API

### Основные компоненты
- `IterativePlanner` - создание и корректировка планов
- `SelfCorrectingExecutor` - выполнение с самопроверкой через Vision
- `ScreenManager` - управление вторым монитором
- `TaskExecutor` - оркестрация выполнения задач

## Git
- Не коммитить `.env`, `__pycache__`, `logs/`, `screenshots/`, `temp/`
- Проверять `.gitignore` перед коммитом
- Логи и скриншоты в `.gitignore`

## .md файлы
- не создавай новых, если я только прямо этого не сказал!

## Общие правила работы
- прежде чем выполнять задачу задай уточняющие вопросы, предложи свои идеи, проясни все, чтобы потом без сомнений сделать правильно
- САМОЕ ВАЖНОЕ: ВСЕГДА, всегда старайся придумать полноценные тесты, которые проверят удачность выполнения нововведений