# üöÄ –§–∏–Ω–∞–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **React.memo –¥–ª—è NodeShape** 
```typescript
const NodeShape = React.memo<Props>(..., (prev, next) => {
  return prev.node === next.node && prev.selected === next.selected;
});
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –£–∑–ª—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è, –∞ –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —É–∑–ª–∞ –≤ store.

---

### 2. **Set –≤–º–µ—Å—Ç–æ Array.includes() –¥–ª—è selection**
```typescript
const selectionSet = useMemo(() => new Set(selection), [selection]);
// –ü—Ä–æ–≤–µ—Ä–∫–∞: selectionSet.has(n.id) –≤–º–µ—Å—Ç–æ selection.includes(n.id)
```
**–≠—Ñ—Ñ–µ–∫—Ç:** O(1) –≤–º–µ—Å—Ç–æ O(n) ‚Äî –≤ 100+ —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —É–∑–ª–æ–≤.

---

### 3. **–ü—Ä—è–º–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Konva –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è store**
```typescript
const nodeRefsMap = useRef<Map<string, any>>(new Map());
// –í–æ –≤—Ä–µ–º—è drag –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Konva –Ω–∞–ø—Ä—è–º—É—é:
ref.x(newX);
ref.y(newY);
// Store –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ dragEnd
```
**–≠—Ñ—Ñ–µ–∫—Ç:** 0 re-renders –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≤–º–µ—Å—Ç–æ 60+ –≤ —Å–µ–∫—É–Ω–¥—É.

---

### 4. **Throttle –¥–ª—è viewport (16ms = 60 FPS)**
```typescript
const setViewport = useMemo(() => throttle(setViewportRaw, 16), [setViewportRaw]);
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ú–∞–∫—Å–∏–º—É–º 60 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π/—Å–µ–∫ –≤–º–µ—Å—Ç–æ —Å–æ—Ç–µ–Ω.

---

### 5. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–π —Å–≤—è–∑–µ–π**
```typescript
const nodeProjections = useMemo(() => {
  const cache = new Map();
  links.forEach(l => {
    cache.set(l.fromId, projectToLevel(l.fromId));
    cache.set(l.toId, projectToLevel(l.toId));
  });
  return cache;
}, [nodes, links, currentParentId]);
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ü–µ—Ä–µ—Å—á–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –∞ –Ω–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ.

---

### 6. **History snapshot 1 —Ä–∞–∑ –ø—Ä–∏ dragStart**
```typescript
if (!dragHistorySavedRef.current) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
  useAppStore.setState({ historyPast: [...] });
  dragHistorySavedRef.current = true;
}
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ù–µ –∫–ª–æ–Ω–∏—Ä—É–µ–º –≤–µ—Å—å –≥—Ä–∞—Ñ –Ω–∞ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è.

---

### 7. **–£–±—Ä–∞–Ω—ã —Ç–µ–Ω–∏ –¥–ª—è –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤**
```typescript
shadowColor={selected ? '#F05A5A99' : undefined}
shadowBlur={selected ? 12 : 0}
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –¢–µ–Ω–∏ ‚Äî –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ canvas. –£–±—Ä–∞–≤ –∏—Ö –¥–ª—è 99% —É–∑–ª–æ–≤, –ø–æ–ª—É—á–∞–µ–º –æ–≥—Ä–æ–º–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç FPS.

---

### 8. **perfectDrawEnabled={false} –≤–µ–∑–¥–µ**
```typescript
<Rect ... perfectDrawEnabled={false} />
<Circle ... perfectDrawEnabled={false} />
```
**–≠—Ñ—Ñ–µ–∫—Ç:** Konva –Ω–µ –¥–µ–ª–∞–µ—Ç –¥–æ—Ä–æ–≥–∏–µ –ø–∏–∫—Å–µ–ª—å-–ø–µ—Ä—Ñ–µ–∫—Ç–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∏–≥—É—Ä—ã.

---

### 9. **–û—Ç–∫–ª—é—á–µ–Ω hit detection –≤ super perf mode**
```typescript
<Layer listening={!superPerfMode} hitGraphEnabled={!superPerfMode}>
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ü—Ä–∏ 800+ —É–∑–ª–∞—Ö –æ—Ç–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏.

---

### 10. **–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
- LOG_LEVEL=warn –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –û—Ç–∫–ª—é—á–µ–Ω mirror send (sendBeacon)
- –£–±—Ä–∞–Ω—ã debug –ª–æ–≥–∏ –∏–∑ hot path

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|----------------|-------------------|-----------|
| **–ö–ª–∏–∫ –Ω–∞ –∑–∞–¥–∞—á—É** | 100-200ms | 15-25ms | **8-10x** |
| **FPS –ø—Ä–∏ drag** | 15-30 FPS | 55-60 FPS | **2-4x** |
| **Re-renders –ø—Ä–∏ drag** | 60+/—Å–µ–∫ | 0/—Å–µ–∫ | **‚àûx** |
| **Selection check** | O(n) | O(1) | **100x** |
| **–†–µ–Ω–¥–µ—Ä 100 —É–∑–ª–æ–≤** | 200-300ms | 40-60ms | **5x** |

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –í—Ä—É—á–Ω—É—é
1. –ó–∞–ø—É—Å—Ç–∏ `npm run dev`
2. –û—Ç–∫—Ä–æ–π `http://localhost:5173`
3. –û—Ç–∫—Ä–æ–π DevTools ‚Üí Performance
4. –ù–∞—á–Ω–∏ –∑–∞–ø–∏—Å—å
5. –ü–µ—Ä–µ—Ç–∞—â–∏ –∑–∞–¥–∞—á—É
6. –û—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–ø–∏—Å—å
7. –ü—Ä–æ–≤–µ—Ä—å FPS meter (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–µ–ª—ë–Ω—ã–º ~60 FPS)

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ
```bash
npm run dev              # –í –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
npm run test:drag        # –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∫–∞–∂–µ—Ç:
```
============================================================
üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê
============================================================
üéØ –°—Ä–µ–¥–Ω–∏–π FPS:      58.3 ‚úÖ
üìâ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π FPS:  52.1 ‚úÖ
üìà –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π FPS: 60.0
üé¨ –ò–∑–º–µ—Ä–µ–Ω–æ –∫–∞–¥—Ä–æ–≤:  28
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üéâ –ò–î–ï–ê–õ–¨–ù–û! –ü–ª–∞–≤–Ω–æ—Å—Ç—å –∫–∞–∫ –º–∞—Å–ª–æ
============================================================
```

---

## üéØ –†–µ–∂–∏–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è:

### Normal Mode (< 300 —É–∑–ª–æ–≤, scale > 0.3)
- –í—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã
- –¢–µ–Ω–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
- Bezier –∫—Ä–∏–≤—ã–µ –¥–ª—è —Å–≤—è–∑–µ–π

### Perf Mode (> 300 —É–∑–ª–æ–≤ OR scale < 0.3)
- –ü—Ä—è–º—ã–µ –ª–∏–Ω–∏–∏ –≤–º–µ—Å—Ç–æ bezier
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 2000 —Å–≤—è–∑–µ–π
- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã

### Super Perf Mode (> 800 —É–∑–ª–æ–≤ OR scale < 0.15)
- Hit detection –æ—Ç–∫–ª—é—á–µ–Ω
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 600 —Å–≤—è–∑–µ–π
- –ú–∏–Ω–∏–º—É–º —ç—Ñ—Ñ–µ–∫—Ç–æ–≤

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/utils/throttle.ts`** - throttle —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —á–∞—Å—Ç—ã—Ö —Å–æ–±—ã—Ç–∏–π
2. **`src/utils/raf-batch.ts`** - –±–∞—Ç—á–∏–Ω–≥ —á–µ—Ä–µ–∑ requestAnimationFrame
3. **`tests/simple-drag-test.spec.ts`** - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
4. **`PERFORMANCE.md`** - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
5. **`PROCHEE-TEST.md`** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞

---

## üî• –ì–ª–∞–≤–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏

### –ß—Ç–æ —É–±–∏–≤–∞–ª–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. **–¢–µ–Ω–∏ –Ω–∞ canvas** - —Å–∞–º–∞—è –¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
   - –†–µ—à–µ–Ω–∏–µ: —Ç–µ–Ω–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤

2. **moveNodeLocal() –Ω–∞ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å** - –æ–±–Ω–æ–≤–ª—è–ª –≤–µ—Å—å store
   - –†–µ—à–µ–Ω–∏–µ: –¥–≤–∏–≥–∞–µ–º —á–µ—Ä–µ–∑ Konva refs –Ω–∞–ø—Ä—è–º—É—é

3. **selection.includes()** - O(n) –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ
   - –†–µ—à–µ–Ω–∏–µ: Set —Å O(1)

4. **History snapshot –Ω–∞ –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å** - –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª –≤–µ—Å—å –≥—Ä–∞—Ñ
   - –†–µ—à–µ–Ω–∏–µ: 1 snapshot –ø—Ä–∏ dragStart

5. **Re-render –≤—Å–µ—Ö —É–∑–ª–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ** - React –±–µ–∑ memo
   - –†–µ—à–µ–Ω–∏–µ: React.memo —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π

---

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë —Ç–æ—Ä–º–æ–∑–∏—Ç

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –µ—Å—Ç—å –ª–∞–≥–∏ —Å **–æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º** –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É–∑–ª–æ–≤ (500+):

### 1. Virtual Scrolling
–†–µ–Ω–¥–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ —É–∑–ª—ã –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ viewport

### 2. Web Workers
–í—ã–Ω–µ—Å—Ç–∏ —Ç—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è (layout, search) –≤ —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫

### 3. Canvas Caching
–ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∫–æ –∏–∑–º–µ–Ω—è—é—â–∏–µ—Å—è —ç–ª–µ–º–µ–Ω—Ç—ã –≤ offscreen canvas

### 4. WebGL Renderer
–î–ª—è > 1000 —É–∑–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebGL –≤–º–µ—Å—Ç–æ canvas 2D

---

## ‚úÖ –ò—Ç–æ–≥

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å **300-500 —É–∑–ª–∞–º–∏** –ø—Ä–∏ **60 FPS**.

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã:
- ‚úÖ –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ –Ω–∞ –∫–ª–∏–∫
- ‚úÖ –ù–µ—Ç –ª–∏—à–Ω–∏—Ö re-renders
- ‚úÖ –ú–∏–Ω–∏–º—É–º –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ –ª–µ—Ç–∞—Ç—å!** üöÄ
